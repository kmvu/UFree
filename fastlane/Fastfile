# fastlane/Fastfile
# Sprint 6.1: Distribution Automation
# Integrated with Appfile + match for hands-off certificate management
# Ensures every build passes tests before reaching testers

default_platform(:ios)

# Load environment variables from .env file
require 'dotenv'
Dotenv.load(File.expand_path("#{File.dirname(__FILE__)}/.env"))

# Helper: Determine if running in CI/CD environment
def is_ci
  ENV["CI"] == "true" || ENV["GITHUB_ACTIONS"] == "true"
end

# App Store Connect API Key (for automated TestFlight submission)
def setup_api_key
  # Ensure .env is loaded
  require 'dotenv'
  Dotenv.load(File.expand_path("#{File.dirname(__FILE__)}/.env"))
  
  app_store_connect_api_key(
    key_id: ENV["ASC_KEY_ID"],
    issuer_id: ENV["ASC_ISSUER_ID"],
    key_filepath: ENV["ASC_KEY_PATH"],
    duration: 1200,
    in_house: false
  )
end

platform :ios do
  desc "Pre-flight Check: Run all 206+ Unit Tests"
  lane :tests do
    puts "ğŸ§ª Running test suite (206+ tests)..."
    run_tests(
      project: "UFree.xcodeproj",
      scheme: "UFreeUnitTests",
      devices: ["iPhone 17 Pro"],
      clean: true,
      fail_build: true,
      output_directory: "fastlane/test_results",
      result_bundle: true,
      derived_data_path: "./fastlane/builds/DerivedData",
      xcargs: "-skipPackagePluginValidation -clonedSourcePackagesDirPath ./fastlane/spm_cache"
    )
    puts "âœ… All tests passed"
  end

  desc "Internal Alpha: Distribute via Firebase App Distribution"
  lane :alpha do
    puts "ğŸš€ Starting Internal Alpha Distribution..."
    
    # 1. Run validation first
    tests
    
    # 2. Build the app for Ad-Hoc distribution
    puts "ğŸ”¨ Building IPA for Firebase distribution..."
    
    # Explicitly grab the provisioning profile mapping
    profile_mapping = lane_context[SharedValues::MATCH_PROVISIONING_PROFILE_MAPPING]
    puts "ğŸ“‹ Provisioning Profile Mapping: #{profile_mapping}"
    
    build_app(
      project: "UFree.xcodeproj",
      scheme: "UFree",
      configuration: "Release",
      export_method: "ad-hoc",
      output_directory: "./fastlane/builds",
      output_name: "UFree.ipa",
      clean: true,
      archive_path: "./fastlane/builds/UFree.xcarchive",
      destination: "generic/platform=iOS",
      build_for_testing: false,
      derived_data_path: "./fastlane/builds/DerivedData",
      xcargs: "-skipPackagePluginValidation -clonedSourcePackagesDirPath ./fastlane/spm_cache",
      export_options: {
        signingStyle: "manual",
        provisioningProfiles: profile_mapping
      }
    )
    
    # 3. Upload to Firebase App Distribution
    puts "ğŸ“¤ Uploading to Firebase App Distribution..."
    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID"] || "1:639000000000:ios:a1b2c3d4e5f6g7h8i9j0",
      ipa_path: "./fastlane/builds/UFree.ipa",
      groups: ENV["FIREBASE_GROUPS"] || "internal-testers",
      release_notes: "Sprint 6.1: Automated Distribution - All 206+ tests validated",
      firebase_cli_path: "/usr/local/bin/firebase"
    )
    
    puts "âœ… Build uploaded to Firebase for internal testing"
  end

  desc "External Beta: Submit to TestFlight"
  lane :beta do
    puts "ğŸ¯ Starting External Beta Build for TestFlight..."
    
    # 0. Fetch project settings once to avoid repeated Xcode metadata lookups
    setup_ci if is_ci
    
    # 1. Full validation: Only ship if all tests pass
    tests
    
    # 2. Setup API key for TestFlight submission
    puts "ğŸ”‘ Setting up App Store Connect API Key..."
    api_key = setup_api_key
    
    # 3. Automation: Fetch/Renew certificates and profiles via match
    puts "ğŸ” Setting up signing certificates with match..."
    match(
      type: "appstore",
      readonly: true,
      skip_confirmation: true,
      api_key: api_key
    )
    
    # 4. Preparation: Auto-increment build number
    puts "ğŸ“Š Incrementing build number..."
    # Note: Marketing Version (CFBundleShortVersionString) should be updated manually in Xcode
    # before running this lane. Build number increments automatically.
    increment_build_number(
      build_number: latest_testflight_build_number(api_key: api_key) + 1
    )

    # 5. Build for the App Store (including dSYMs for crash reporting)
    puts "ğŸ”¨ Building IPA for App Store..."
    
    # Explicitly grab the provisioning profile mapping from match
    profile_mapping = lane_context[SharedValues::MATCH_PROVISIONING_PROFILE_MAPPING]
    puts "ğŸ“‹ Provisioning Profile Mapping: #{profile_mapping}"
    
    build_app(
      project: "UFree.xcodeproj",
      scheme: "UFree",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./fastlane/builds",
      output_name: "UFree.ipa",
      clean: true,
      archive_path: "./fastlane/builds/UFree.xcarchive",
      destination: "generic/platform=iOS",
      include_symbols: true,
      include_bitcode: false,
      derived_data_path: "./fastlane/builds/DerivedData",
      xcargs: "-skipPackagePluginValidation -clonedSourcePackagesDirPath ./fastlane/spm_cache",
      export_options: {
        signingStyle: "manual",
        provisioningProfiles: profile_mapping
      }
    )

    # 5.1 Upload dSYMs to Firebase Crashlytics
    puts "ğŸ“¤ Uploading dSYMs to Firebase Crashlytics..."
    upload_symbols_to_crashlytics(
      gsp_path: "GoogleService-Info.plist"
    )

    # 6. Upload to TestFlight
    puts "ğŸ“¤ Uploading to TestFlight..."
    upload_to_testflight(
      ipa: "./fastlane/builds/UFree.ipa",
      skip_waiting_for_build_processing: true,
      skip_submission: false,
      distribute_external: false,
      notify_external_testers: true,
      api_key: api_key,
      beta_app_review_info: {
        contact_email: ENV["APPLE_ID"] || "kmvu91@gmail.com",
        contact_first_name: "Test_account",
        contact_last_name: "#{latest_build}",
        contact_phone: "+84932440258",
        demo_account_name: "test+ufree_#{latest_build}@example.com",
        demo_account_password: "password123",
        notes: "Real-world testing for availability discovery feature"
      }
    )
    
    puts "âœ… Build uploaded to TestFlight with Crashlytics reporting enabled"
  end

  # Helper lanes for common tasks
  desc "Get latest TestFlight build number"
  lane :get_testflight_build_number do
    api_key = setup_api_key
    latest_build = latest_testflight_build_number(api_key: api_key)
    puts "ğŸ“Š Latest TestFlight build number: #{latest_build}"
  end

  desc "Run tests and generate report"
  lane :test_report do
    puts "ğŸ“‹ Running tests with detailed report..."
    run_tests(
      project: "UFree.xcodeproj",
      scheme: "UFreeUnitTests",
      devices: ["iPhone 17 Pro"],
      clean: true,
      fail_build: true,
      output_directory: "fastlane/test_results",
      result_bundle: true,
      slack_url: ENV["SLACK_WEBHOOK"]
    )
  end

  desc "Sync certificates and profiles (manual run if needed)"
  lane :sync_certs do
    puts "ğŸ” Syncing certificates with match..."
    api_key = setup_api_key
    
    match(
      type: "appstore",
      readonly: is_ci,
      skip_confirmation: true,
      api_key: api_key
    )
  end
end

# Helper function to get info plist value
def get_info_plist_value(key:)
  return `cd #{Dir.pwd} && /usr/libexec/PlistBuddy -c "Print #{key}" UFree/Info.plist 2>/dev/null`.strip
end
